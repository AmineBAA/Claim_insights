# -*- coding: utf-8 -*-
"""Claim_insights.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1j6PydEgbim2cDv5N-_02smUvVGDMMeQL
"""

import streamlit as st
import pandas as pd
import datetime as dt
import io

st.set_page_config(page_title="Reporting RÃ©clamations", layout="wide")

st.title("ğŸ“Š Reporting RÃ©clamations Clients")

uploaded_file = st.file_uploader("ğŸ“ TÃ©lÃ©versez le fichier Excel des rÃ©clamations", type=["xlsx"])

if uploaded_file:
    df = pd.read_excel(uploaded_file)

    # Nettoyage dates
    today = pd.to_datetime(dt.datetime.today().date())
    df["DATE CREATION"] = pd.to_datetime(df["DATE CREATION"], errors='coerce')
    df["DATE CLOTURE"] = pd.to_datetime(df["DATE CLOTURE"], errors='coerce')

    # DÃ©lai JO recalculÃ©
    df["DÃ©lai JO recalculÃ©"] = (df["DATE CLOTURE"].fillna(today) - df["DATE CREATION"]).dt.days

    # Tranches
    def categorize_delay(d):
        if pd.isna(d):
            return "Non dÃ©fini"
        elif d < 10:
            return "< 10 jours"
        elif 10 <= d <= 40:
            return "10 Ã  40 jours"
        else:
            return "> 40 jours"

    df["Tranche dÃ©lai"] = df["DÃ©lai JO recalculÃ©"].apply(categorize_delay)

    # Montant restituÃ©
    df["Montant RestituÃ©"] = df.apply(
        lambda x: x["MONTANT RESTITUTION"] if str(x["RESTITUTION"]).strip().upper() == "OUI" else 0, axis=1)
    total_restitution = df["Montant RestituÃ©"].sum()

    # --- ğŸ” Filtres ---
    st.sidebar.header("ğŸ” Filtres")
    tranche_filtre = st.sidebar.multiselect("Tranche dÃ©lai", df["Tranche dÃ©lai"].unique(), default=df["Tranche dÃ©lai"].unique())
    responsable_filtre = st.sidebar.multiselect("Responsable", df["RESPONSABLE"].dropna().unique(), default=df["RESPONSABLE"].dropna().unique())
    statut_filtre = st.sidebar.multiselect("Statut", df["STATUS"].dropna().unique(), default=df["STATUS"].dropna().unique())
    canal_filtre = st.sidebar.multiselect("Canal source", df["CANAL SOURCE"].dropna().unique(), default=df["CANAL SOURCE"].dropna().unique())

    # --- ğŸ¯ Application des filtres ---
    df_filtered = df[
        df["Tranche dÃ©lai"].isin(tranche_filtre) &
        df["RESPONSABLE"].isin(responsable_filtre) &
        df["STATUS"].isin(statut_filtre) &
        df["CANAL SOURCE"].isin(canal_filtre)
    ]

    # --- ğŸ“ˆ Affichages statistiques ---
    st.subheader("ğŸ“Œ Statistiques par Tranche de DÃ©lai")
    st.bar_chart(df_filtered["Tranche dÃ©lai"].value_counts())

    st.subheader("ğŸ’° Montant total restituÃ©")
    st.metric("Total", f"{df_filtered['Montant RestituÃ©'].sum():,.2f} MAD")

    st.subheader("ğŸ‘¤ RÃ©clamations par Responsable")
    st.bar_chart(df_filtered["RESPONSABLE"].value_counts())

    st.subheader("ğŸ¢ RÃ©clamations par EntitÃ© Responsable")
    st.bar_chart(df_filtered["ENTITE RESPONSABLE"].value_counts())

    st.subheader("ğŸ·ï¸ RÃ©clamations par Famille")
    st.bar_chart(df_filtered["FAMILLE"].value_counts())

    st.subheader("âš–ï¸ RÃ©clamations FondÃ©es vs Non FondÃ©es")
    st.bar_chart(df_filtered["FONDEE"].value_counts())

    st.subheader("ğŸ“¡ RÃ©clamations par Canal Source")
    st.bar_chart(df_filtered["CANAL SOURCE"].value_counts())

    # --- ğŸ“¥ TÃ©lÃ©chargement fichier enrichi ---
    st.subheader("ğŸ“¥ TÃ©lÃ©charger le fichier enrichi filtrÃ©")
    buffer = io.BytesIO()
    with pd.ExcelWriter(buffer, engine="xlsxwriter") as writer:
        df_filtered.to_excel(writer, index=False, sheet_name="RÃ©clamations filtrÃ©es")
        writer.save()
        st.download_button("ğŸ“ TÃ©lÃ©charger Excel", data=buffer.getvalue(),
                           file_name="Reclamations_filtrees.xlsx", mime="application/vnd.ms-excel")